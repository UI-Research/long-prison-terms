<html>
<head>
  <link rel="stylesheet" type="text/css" href="css/style.css"/>

</head>
<body>
<div id = "map">
</div>

<script src="data/stateData.js"></script>
<script src="js/d3.js"></script>
<script>

var pageSize = "large"
var mapSizes = {
	"huge": { "width": 900, "height": 1270, "scale": 3800, "translate": [380,220], "chartWidth": 76, "chartMargin": 8},
	"large": { "width": 900, "height": 1270, "scale": 3100, "translate": [380,220], "chartWidth": 62, "chartMargin": 5},
	"medium": { "width": 900, "height": 1270, "scale": 3800, "translate": [380,220], "chartWidth": 76, "chartMargin": 8},
	"small": { "width": 900, "height": 1270, "scale": 3800, "translate": [380,220], "chartWidth": 76, "chartMargin": 8}
}


var mapSvg = null;

  var mapMargin = {top: 30, right: 20, bottom: 30, left: 50},
    mapWidth = mapSizes[pageSize]["width"] - mapMargin.left - mapMargin.right,
    mapHeight = mapSizes[pageSize]["height"] - mapMargin.top - mapMargin.bottom;


mapSvg = d3.select("#map")
	.append("svg")
	    .attr("width", mapWidth + mapMargin.left + mapMargin.right)
	    .attr("height", mapHeight + mapMargin.top + mapMargin.bottom)
	.append("g")
	    .attr("transform", 
	          "translate(" + mapMargin.left + "," + mapMargin.top + ")");

var projection = d3.geo.equirectangular()
  .scale(mapSizes[pageSize]["scale"])
  .center([-96.03542,41.69553])
  .translate(mapSizes[pageSize]["translate"]);

var geoPath = d3.geo.path()
  .projection(projection);



d3.csv("data/trendsData.csv", function(trendsData){

	trendsData = trendsData.filter(function(o){
		return +o.Year >= 2000
	})
	trendsData.forEach(function(d) {
      d.LOS_Mean = +d.LOS_Mean
      d.Year = +d.Year;
    });
	var trendsDataNest = d3.nest()
		.key(function(d) {return d.State;})
		.entries(trendsData);

	var tmpKeys = []
	for(var i = 0; i < trendsDataNest.length; i++){
		var obj = trendsDataNest[i]
		if(obj.hasOwnProperty("key")){
			tmpKeys.push(obj.key)
		}
	}
	// console.log(tmpKeys)

	var blankStateData = stateData.features.filter(function(o) { return tmpKeys.indexOf(o.properties.abbr) == -1})
	// console.log(blankStateData)
	// var chartWidth = mapWidth/11
	var chartWidth = mapSizes[pageSize]["chartWidth"]
	var chartMargin = mapSizes[pageSize]["chartMargin"]
	var map = mapSvg
		.selectAll(".state")
		.data(trendsDataNest)
		.enter()
		.append("g")
		.attr("class","state")
        .attr("transform", function(d,i){
            var tmp = stateData.features.filter(function(o) { return o.properties.abbr == d.key} )
            return "translate(" + geoPath.centroid(tmp[0]) + ")"

        })

    var blank = mapSvg
		.selectAll(".blank")
		.data(blankStateData)
		.enter()
		.append("g")
		.attr("class","blank")
        .attr("transform", function(d,i){
            // var tmp = stateData.features.filter(function(o) { return o.properties.abbr == d.key} )
            return "translate(" + geoPath.centroid(d) + ")"

        })

    blank.append("rect")
    	.attr("width",chartWidth-2*chartMargin)
    	.attr("height",chartWidth-2*chartMargin)
    	.attr("x",chartMargin)
    	.attr("y",chartMargin)
    	.style("fill","#e3e3e3") 

	    // map.append("rect")
	    // 	.attr("width",chartWidth-2*chartMargin)
	    // 	.attr("height",chartWidth-2*chartMargin)
	    // 	.attr("x",chartMargin)
	    // 	.attr("y",chartMargin)
	    // 	.style("fill","#9d9d9d") 


    var mapX = d3.scale.linear().range([chartMargin, chartWidth-chartMargin]);
    var mapY = d3.scale.linear().range([chartWidth-chartMargin, chartMargin]);


    mapX.domain(d3.extent(trendsData, function(d) { return d.Year; }));
    mapY.domain([0, d3.max(trendsData, function(d) { return d.LOS_Mean; })]); 

    var mapXAxis = d3.svg.axis().scale(mapX)
        .orient("bottom").outerTickSize(0);

    var mapYAxis = d3.svg.axis().scale(mapY)
        .orient("left").outerTickSize(0);

    var mapline = d3.svg.line()
        .x(function(d) { return mapX(d.Year); })
        .y(function(d) { return mapY(d.LOS_Mean); });



	map.append("path")
		.attr("class", "line")
        .attr("d", function(d){ console.log(d.values); return mapline(d.values)})

    map.append("g")
        .attr("class", "x axis")
        .attr("transform", "translate(0," + (chartWidth-chartMargin) + ")")
        .call(mapXAxis);

    // Add the Y Axis
    map.append("g")
        .attr("class", "y axis")
	    .attr("transform", "translate(" + chartMargin + ",0)")
        .call(mapYAxis);

		// .text(function(d){ console.log(d); return d.key })


})
                   // d3.select(c).selectAll(".small_chart")
                   //  .transition()
                   //  .duration(1000)
                   //  .delay(function(d,i){
                   //    return 200* i/52
                   //  })
                   //  .attr("transform", function(d,i){
                   //    var tmp = stateData.features.filter(function(o) { return o.properties.abbr == d.location} )
                   //    return "translate(" + path.centroid(tmp[0]) + ")"
                   //  })


 </script>
 </body>
 </html>